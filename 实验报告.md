# 编译第三次实验实验报告
## 小组成员及分工
- 张佳和：expression中以下部分的解析以及对应测试用例、测试程序的编写
      
      $.type_conversion_expression,
      $.identifier,
      alias(choice('new', 'make'), $.identifier),
      $.composite_literal,
      $.func_literal,
      $._string_literal,
      $.int_literal,
      $.float_literal,
    
- 宋岱桉：
- 郑仁哲：
## 实验思路及核心代码
1. 查看ppt，不懂的问助教和老师以及自己摸索
2. 分工
3. 张佳和部分
    1.  `type_conversion_expression`部分注册在expression_handler下，将operator设置为cast，operand设置为要转型的类型，target设置为被转型的表达式内容，增加`{"assign_stmt": {"target": shadow_operand, "operand": self.read_node_text(type), "operator": 'cast'}}`statement语句即可
    代码如下
    ```python
    def type_conversion_expression(self, node, statements):
        operand = self.find_child_by_field(node, "operand")#the expression to be converted
        type = self.find_child_by_field(node, "type")
        shadow_operand = self.parse(operand, statements)
        statements.append({"assign_stmt": {"target": shadow_operand, "operand": self.read_node_text(type), "operator": 'cast'}})
        return shadow_operand
    ```
    测试发现go的转型语法和函数调用冲突，用例被当成函数调用处理，经与助教沟通，可忽略该表达式解析效果
    2. `identifier`部分就十分简单，利用`regualr_literal`返回字面值就行
    代码如下
    ```python
    def regular_literal(self, node, statements, replacement):
        return self.read_node_text(node)
    ``` 
    3. `composite_literal`由于包含太多复杂结构的字面量解析，暂时不处理
    4. `func_literal`在literal注册表中调用`func_literal`方法解析，借助`parse_parameters`方法处理parameters的node从而得到`parameters`，由于是匿名函数，调用`tmp_method`方法获得匿名函数编号，body部分递归解析其中语句得到`new_body`，最终statements中增加` {"method_decl": { "attr":attr,"data_type": mytype, "name": tmp, "parameters": parameters,"body": new_body,"init": init,"type_parameters": type_parameters,}}`即可。
    `func_literal`代码较长不放在这里了,`parse_parameters`函数需要处理两种不同的node类型，分别是变长参数和定长参数，定长参数要考虑到go中类型的省略，需要for循环生成与name数量相同的parameter_decl语句。代码如下：
    ```python
     def parse_parameters(self,node,statements):
        modifiers = []
        mytype = self.find_child_by_field(node, "type")
        shadow_type = self.read_node_text(mytype)
        name = self.find_child_by_field(node, "name")
        shadow_name=self.read_node_text(name)   
        if node.type=='variadic_parameter_declaration':
            modifiers.append('variadic')
            statements.append({"parameter_decl": {"name": shadow_name, "data_type": shadow_type, "modifiers": modifiers}})
        else :
            children=node.children_by_field_name('name')
            for child in children:#all the parameter decl of the same type processing
                    shadow_name=self.read_node_text(child)
                    statements.append({"parameter_decl": {"name": shadow_name, "data_type": shadow_type, "modifiers": modifiers}})
    ```

    5. `_string_literal`分为raw_string_literal和interpreted_string_literal，在`string_literal`函数中处理，对于raw_string_literal，去除反引号增加双引号就行，而interpreted_string_literal需要进行转义处理。然而测试表明转义函数`handle_hex_string`和`escape_string`没什么用……。
    代码如下：
    ```python
     def string_literal(self, node, statements, replacement):
        ret=''
        if node.type == "raw_string_literal":
            ret ='"'+self.read_node_text(node)[1:-1]+'"'#remove the surrounding ``
            return ret#no need for escape processing for it's raw
        # else type==interpreted_string_literal
        else:
            ret = self.read_node_text(node)#[1:-1]#remove the surrounding ""
        ret = self.handle_hex_string(ret)
        # return ret
        return self.escape_string(ret)
    ```

    6. `int_literal`和`float_literal`均在注册函数表中用`regular_number_literal`函数处理，出于可能的16进制浮点数常量考虑，需特别处理浮点常量，代码如下
    ```python
    def regular_number_literal(self, node, statements, replacement):
        value = self.read_node_text(node)
        if node.type=='float_literal':
            try:
                value = float.fromhex(value)
            except:
                value = self.common_eval(value)
        else:
            value = self.common_eval(value)  
        return str(value)
    ```

## 测试用例与结果
1. 张佳和部分
    1.  type_conversion_expression.go，内容如下
    ```go
     string(5+"gag")
     ```
    因为语法被视作函数调用，结果是call_stmt
    ```
    [{'assign_stmt': {'target': '%v0',
                  'operator': '+',
                  'operand': '5',
                  'operand2': '"gag"'}},
    {'call_stmt': {'target': '%v1',
                'name': 'string',
                'type_parameters': '',
                'args': ['%v0']}}]
    [{'operation': 'assign_stmt',
    'stmt_id': 1,
    'target': '%v0',
    'operator': '+',
    'operand': '5',
    'operand2': '"gag"'},
    {  'operation': 'call_stmt',
    'stmt_id': 2,
    'target': '%v1',
    'name': 'string',
    'type_parameters': '',
    'args': "['%v0']"}]
    ```
    2. identifier.go，测试标识符，内容如下
    ```go
    lksdjag
    cxvas
    *sdaf
    new.va()
    make+gsd 
    ```
    测试结果
    ```
        [{'assign_stmt': {'target': '%v0', 'operator': '*', 'operand': 'sdaf'}},
     {'field_read': {'target': '%v1', 'receiver_object': 'new', 'field': 'va'}},
     {'call_stmt': {'target': '%v2',
                    'name': '%v1',
                    'type_parameters': '',
                    'args': []}},
     {'assign_stmt': {'target': '%v3',
                      'operator': '+',
                      'operand': 'make',
                      'operand2': 'gsd'}}]
    [{'operation': 'assign_stmt',
      'stmt_id': 1,
      'target': '%v0',
      'operator': '*',
      'operand': 'sdaf'},
     {'operation': 'field_read',
      'stmt_id': 2,
      'target': '%v1',
      'receiver_object': 'new',
      'field': 'va'},
     {'operation': 'call_stmt',
      'stmt_id': 3,
      'target': '%v2',
      'name': '%v1',
      'type_parameters': '',
      'args': None},
     {'operation': 'assign_stmt',
      'stmt_id': 4,
      'target': '%v3',
      'operator': '+',
      'operand': 'make',
      'operand2': 'gsd'}]
    ```
    3. func_literal.go，内容：
    ```go
    1+func (c *Client)int{return 1}
    func() string {
    	func(nums ...int) int {
    		241
    	}(1,2,4,5)
    }
    func(a, b int, callback func(int, int) int) int {
    	 callback(a, b)
    }(10, 20, func(x, y int) int {
    	 x * y
    })
    ```
    结果：
    ```
    [{'method_decl': {'attr': [],
                      'data_type': 'int',
                      'name': '%m0',
                      'parameters': [{'parameter_decl': {'name': 'c',
                                                         'data_type': '*Client',
                                                         'modifiers': []}}],
                      'body': [],
                      'init': [],
                      'type_parameters': []}},
     {'assign_stmt': {'target': '%v0',
                      'operator': '+',
                      'operand': '1',
                      'operand2': '%m0'}},
     {'method_decl': {'attr': [],
                      'data_type': 'string',
                      'name': '%m1',
                      'parameters': [],
                      'body': [{'method_decl': {'attr': [],
                                                'data_type': 'int',
                                                'name': '%m2',
                                                'parameters': [{'parameter_decl': {'name': 'nums',
                                                                                   'data_type': 'int',
                                                                                   'modifiers': ['variadic']}}],
                                                'body': [],
                                                'init': [],
                                                'type_parameters': []}},
                               {'call_stmt': {'target': '%v0',
                                              'name': '%m2',
                                              'type_parameters': '',
                                              'args': ['1', '2', '4', '5']}}],
                      'init': [],
                      'type_parameters': []}},
     {'method_decl': {'attr': [],
                      'data_type': 'int',
                      'name': '%m3',
                      'parameters': [{'parameter_decl': {'name': 'b',
                                                         'data_type': 'int',
                                                         'modifiers': []}},
                                     {'parameter_decl': {'name': 'a',
                                                         'data_type': 'int',
                                                         'modifiers': []}},
                                     {'parameter_decl': {'name': 'callback',
                                                         'data_type': 'func(int, '
                                                                      'int) int',
                                                         'modifiers': []}}],
                      'body': [{'call_stmt': {'target': '%v0',
                                              'name': 'callback',
                                              'type_parameters': '',
                                              'args': ['a', 'b']}}],
                      'init': [],
                      'type_parameters': []}},
     {'method_decl': {'attr': [],
                      'data_type': 'int',
                      'name': '%m4',
                      'parameters': [{'parameter_decl': {'name': 'y',
                                                         'data_type': 'int',
                                                         'modifiers': []}},
                                     {'parameter_decl': {'name': 'x',
                                                         'data_type': 'int',
                                                         'modifiers': []}}],
                      'body': [{'assign_stmt': {'target': '%v0',
                                                'operator': '*',
                                                'operand': 'x',
                                                'operand2': 'y'}}],
                      'init': [],
                      'type_parameters': []}},
     {'call_stmt': {'target': '%v1',
                    'name': '%m3',
                    'type_parameters': '',
                    'args': ['10', '20', '%m4']}}]
    [{'operation': 'method_decl',
      'stmt_id': 1,
      'attr': None,
      'data_type': 'int',
      'name': '%m0',
      'parameters': 2,
      'body': None,
      'init': None,
      'type_parameters': None},
     {'operation': 'block_start', 'stmt_id': 2, 'parent_stmt_id': 1},
     {'operation': 'parameter_decl',
      'stmt_id': 3,
      'name': 'c',
      'data_type': '*Client',
      'modifiers': None},
     {'operation': 'block_end', 'stmt_id': 2, 'parent_stmt_id': 1},
     {'operation': 'assign_stmt',
      'stmt_id': 4,
      'target': '%v0',
      'operator': '+',
      'operand': '1',
      'operand2': '%m0'},
     {'operation': 'method_decl',
      'stmt_id': 5,
      'attr': None,
      'data_type': 'string',
      'name': '%m1',
      'parameters': None,
      'body': 6,
      'init': None,
      'type_parameters': None},
     {'operation': 'block_start', 'stmt_id': 6, 'parent_stmt_id': 5},
     {'operation': 'method_decl',
      'stmt_id': 7,
      'attr': None,
      'data_type': 'int',
      'name': '%m2',
      'parameters': 8,
      'body': None,
      'init': None,
      'type_parameters': None},
     {'operation': 'block_start', 'stmt_id': 8, 'parent_stmt_id': 7},
     {'operation': 'parameter_decl',
      'stmt_id': 9,
      'name': 'nums',
      'data_type': 'int',
      'modifiers': "['variadic']"},
     {'operation': 'block_end', 'stmt_id': 8, 'parent_stmt_id': 7},
     {'operation': 'call_stmt',
      'stmt_id': 10,
      'target': '%v0',
      'name': '%m2',
      'type_parameters': '',
      'args': "['1', '2', '4', '5']"},
     {'operation': 'block_end', 'stmt_id': 6, 'parent_stmt_id': 5},
     {'operation': 'method_decl',
      'stmt_id': 11,
      'attr': None,
      'data_type': 'int',
      'name': '%m3',
      'parameters': 12,
      'body': 16,
      'init': None,
      'type_parameters': None},
     {'operation': 'block_start', 'stmt_id': 12, 'parent_stmt_id': 11},
     {'operation': 'parameter_decl',
      'stmt_id': 13,
      'name': 'b',
      'data_type': 'int',
      'modifiers': None},
     {'operation': 'parameter_decl',
      'stmt_id': 14,
      'name': 'a',
      'data_type': 'int',
      'modifiers': None},
     {'operation': 'parameter_decl',
      'stmt_id': 15,
      'name': 'callback',
      'data_type': 'func(int, int) int',
      'modifiers': None},
     {'operation': 'block_end', 'stmt_id': 12, 'parent_stmt_id': 11},
     {'operation': 'block_start', 'stmt_id': 16, 'parent_stmt_id': 11},
     {'operation': 'call_stmt',
      'stmt_id': 17,
      'target': '%v0',
      'name': 'callback',
      'type_parameters': '',
      'args': "['a', 'b']"},
     {'operation': 'block_end', 'stmt_id': 16, 'parent_stmt_id': 11},
     {'operation': 'method_decl',
      'stmt_id': 18,
      'attr': None,
      'data_type': 'int',
      'name': '%m4',
      'parameters': 19,
      'body': 22,
      'init': None,
      'type_parameters': None},
     {'operation': 'block_start', 'stmt_id': 19, 'parent_stmt_id': 18},
     {'operation': 'parameter_decl',
      'stmt_id': 20,
      'name': 'y',
      'data_type': 'int',
      'modifiers': None},
     {'operation': 'parameter_decl',
      'stmt_id': 21,
      'name': 'x',
      'data_type': 'int',
      'modifiers': None},
     {'operation': 'block_end', 'stmt_id': 19, 'parent_stmt_id': 18},
     {'operation': 'block_start', 'stmt_id': 22, 'parent_stmt_id': 18},
     {'operation': 'assign_stmt',
      'stmt_id': 23,
      'target': '%v0',
      'operator': '*',
      'operand': 'x',
      'operand2': 'y'},
     {'operation': 'block_end', 'stmt_id': 22, 'parent_stmt_id': 18},
     {'operation': 'call_stmt',
      'stmt_id': 24,
      'target': '%v1',
      'name': '%m3',
      'type_parameters': '',
      'args': "['10', '20', '%m4']"}]
      ```
    4. string_literal.go，内容：
    ```go
    "asdasda"-1
    `sdfsdfsdf`+`\n\asdfasdfb\'`
    "sadf\n\t\a"+"sbxcv\u3255"
    ```
    结果：
    ```
    [{'assign_stmt': {'target': '%v0',
                      'operator': '-',
                      'operand': '"asdasda"',
                      'operand2': '1'}},
     {'assign_stmt': {'target': '%v1',
                      'operator': '+',
                      'operand': '"sdfsdfsdf"',
                      'operand2': '"\\n\\asdfasdfb\\\'"'}},
     {'assign_stmt': {'target': '%v2',
                      'operator': '+',
                      'operand': '"sadf\\n\\t\\a"',
                      'operand2': '"sbxcv\\u3255"'}}]
    [{'operation': 'assign_stmt',
      'stmt_id': 1,
      'target': '%v0',
      'operator': '-',
      'operand': '"asdasda"',
      'operand2': '1'},
     {'operation': 'assign_stmt',
      'stmt_id': 2,
      'target': '%v1',
      'operator': '+',
      'operand': '"sdfsdfsdf"',
      'operand2': '"\\n\\asdfasdfb\\\'"'},
     {'operation': 'assign_stmt',
      'stmt_id': 3,
      'target': '%v2',
      'operator': '+',
      'operand': '"sadf\\n\\t\\a"',
      'operand2': '"sbxcv\\u3255"'}]
    ```
    5.num.go，测试int_literal和float_literal，内容：
    ```go
    1e24
    2.451
    21325-0x143
    5e-2+213
    make+0x1.5p2
    ```
    结果：
    ```
    [{'assign_stmt': {'target': '%v0',
                      'operator': '-',
                      'operand': '21325',
                      'operand2': '323'}},
     {'assign_stmt': {'target': '%v1',
                      'operator': '+',
                      'operand': '0.05',
                      'operand2': '213'}},
     {'assign_stmt': {'target': '%v2',
                      'operator': '+',
                      'operand': 'make',
                      'operand2': '5.25'}}]
    [{'operation': 'assign_stmt',
      'stmt_id': 1,
      'target': '%v0',
      'operator': '-',
      'operand': '21325',
      'operand2': '323'},
     {'operation': 'assign_stmt',
      'stmt_id': 2,
      'target': '%v1',
      'operator': '+',
      'operand': '0.05',
      'operand2': '213'},
     {'operation': 'assign_stmt',
      'stmt_id': 3,
      'target': '%v2',
      'operator': '+',
      'operand': 'make',
      'operand2': '5.25'}]
      ```
      